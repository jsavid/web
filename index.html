<script>
  // Guardar y cargar datos
  const fields = [
    "portraitUrl", "nombre", "raza", "claseNivel", "alineamiento",
    "caracteristicas", "habilidades", "inventario", "hechizos"
  ];

  // Obtener referencias
  const portraitInput = document.querySelector('input[placeholder="Pega aquí una URL de imagen"]');
  const nombreInput = document.querySelector('input[placeholder="Ej. Aeris Nightshade"]');
  const razaInput = document.querySelector('input[placeholder="Ej. Elfo oscuro"]');
  const claseNivelInput = document.querySelector('input[placeholder="Ej. Hechicero 5"]');
  const alineamientoInput = document.querySelector('input[placeholder="Ej. Caótico Bueno"]');
  const caracteristicasInput = document.querySelector('textarea[placeholder^="FUE"]');
  const habilidadesInput = document.querySelector('textarea[placeholder^="Visión"]');
  const inventarioInput = document.querySelector('textarea[placeholder^="Espada"]');
  const hechizosInput = document.querySelector('textarea[placeholder^="Prestidigitación"]');
  const portraitDiv = document.getElementById('portrait');

  // Cargar datos
  window.onload = function() {
    portraitInput.value = localStorage.getItem(fields[0]) || "";
    nombreInput.value = localStorage.getItem(fields[1]) || "";
    razaInput.value = localStorage.getItem(fields[2]) || "";
    claseNivelInput.value = localStorage.getItem(fields[3]) || "";
    alineamientoInput.value = localStorage.getItem(fields[4]) || "";
    caracteristicasInput.value = localStorage.getItem(fields[5]) || "";
    habilidadesInput.value = localStorage.getItem(fields[6]) || "";
    inventarioInput.value = localStorage.getItem(fields[7]) || "";
    hechizosInput.value = localStorage.getItem(fields[8]) || "";

    if (portraitInput.value) updateImage(portraitInput.value);
  };

  // Guardar datos al cambiar
  [portraitInput, nombreInput, razaInput, claseNivelInput, alineamientoInput,
   caracteristicasInput, habilidadesInput, inventarioInput, hechizosInput].forEach((el, i) => {
    el.addEventListener('input', () => {
      localStorage.setItem(fields[i], el.value);
      if (i === 0) updateImage(el.value);
    });
  });

  // Validación de imagen
  function updateImage(url) {
    if (!url) {
      portraitDiv.style.backgroundImage = "url('img/hechicero.png')";
      return;
    }
    // Validar formato básico de URL de imagen
    if (/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i.test(url)) {
      portraitDiv.style.backgroundImage = `url('${url}')`;
      portraitInput.setCustomValidity("");
    } else {
      portraitDiv.style.backgroundImage = "url('img/hechicero.png')";
      portraitInput.setCustomValidity("URL inválida. Debe terminar en jpg, png, gif o webp.");
    }
  }

  // Botón imprimir
  const printBtn = document.createElement('button');
  printBtn.textContent = "Imprimir hoja";
  printBtn.style = "margin: 20px auto; display: block; background: #7b2c2c; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-size: 1.1em; cursor: pointer;";
  printBtn.onclick = () => window.print();
  document.querySelector('.container').appendChild(printBtn);
</script>